/*! DumbQ API v1.0 | Ioannis Charalampidis, Citizen Cyberlab EU Project | GNU GPL v2.0 License */
(window.define==undefined?function(b,a){window.DQFrontEnd=a($||jQuery)}:window.define)(["jquery"],function(b){if(!b){console.error("CreditPiggy: jQuery must available in order to use creditpiggy.js!");return null}var a=function(){this.baseUrl=null;this.pollTimer=null;this.pollActive=false;this.disabled=false;this.online=false;this.seq_id=0;this.machine={};this.index={};this.instances=[]};a.prototype.__same=function(d,c){for(var e in d){if(d.hasOwnProperty(e)){if(c.hasOwnProperty(e)){if(typeof(d[e])!=typeof(c[e])){return false}if(typeof(d[e]=="object")){if(!this.__same(d[e],c[e])){return false}}if(d[e]!=c[e]){return false}}else{return false}}}for(var e in c){if(c.hasOwnProperty(e)&&!d.hasOwnProperty(e)){return false}}return true};a.prototype.__markOfflineInstance=function(c){if(c.offline){return}c.offline=true;b(this).triggerHandler("offline.instance",[c])};a.prototype.__updateInstance=function(c,d){if(c.offline){c.metrics=d;c.offline=false;b(this).triggerHandler("online.instance",[c]);b(this).triggerHandler("metrics.instance",[d,c]);return}if(!this.__same(c.metrics,d)){c.metrics=d;b(this).triggerHandler("metrics.instance",[d,c])}};a.prototype.__updateIndex=function(g){this.index=index;var k=index.instances||[];for(var e=0;e<k.length;e++){var f=k[e],h=false;for(var c=0;c<this.instances.length;c++){var d=this.instances[c];if(f.uuid==d.uuid){h=true;break}}if(!h){index.instances[e]["offline"]=true;index.instances[e]["metrics"]={};b(this).triggerHandler("created.instance",[f])}}for(var e=0;e<this.instances.length;e++){var f=this.instances[e],h=false;for(var c=0;c<k.length;c++){var d=k[c];if(f.uuid==d.uuid){h=true;break}}if(!h){b(this).triggerHandler("destroyed.instance",[f])}}this.instances=index.instances||[]};a.prototype.__updateMachine=function(c){this.machine=c;if(!this.offline){this.offline=false;b(this).triggerHandler("online",[this.machine])}};a.prototype.__markOffline=function(){if(this.offline){return}for(var c=0;c<this.instances.length;c++){this.__markOfflineInstance(this.instances[c])}this.instances=[];this.index={};this.machine={};this.offline=true;b(this).triggerHandler("offline")};a.prototype.__poll=function(){if(this.pollActive||this.disabled){return}var d=(function(){this.pollActive=false;this.pollTimer=setTimeout(this.__poll.bind(this),1000)}).bind(this);var f=(function(h,i){b.ajax({url:this.baseUrl+h.wwwroot+"/metrics.json",method:"GET",dataType:"json",data:{s:(this.seq_id++)}}).done((function(j){this.__updateInstance(h,j)}).bind(this)).fail((function(){this.__markOfflineInstance(h)}).bind(this)).always((function(){i()}).bind(this))}).bind(this);var e=(function(){var k=[d];for(var h=0;h<this.instances.length;h++){k.unshift((function(i){return function(l){f(i,l)}})(this.instances[h]))}var j=function(){if(k.length==1){var i=k.shift();i()}else{var i=k.shift();i(j)}};j()}).bind(this);var c=(function(){b.ajax({url:this.baseUrl+"/index.json",method:"GET",dataType:"json",data:{s:(this.seq_id++)}}).done((function(h){this.__updateIndex(h);e()}).bind(this)).fail((function(){this.__markOffline();d()}).bind(this))}).bind(this);var g=(function(){b.ajax({url:this.baseUrl+"/machine.json",method:"GET",dataType:"json",data:{s:(this.seq_id++)}}).done((function(h){this.__updateMachine(h);c()}).bind(this)).fail((function(){this.__markOffline();d()}).bind(this))}).bind(this);this.pollActive=null;if(this.offline){g()}else{c()}};a.prototype.enable=function(c){this.baseUrl=c;this.disabled=false;this.__poll()};a.prototype.disable=function(){if(this.disabled){return}this.disabled=true};return a});