/*! DumbQ API v1.0 | Ioannis Charalampidis, Citizen Cyberlab EU Project | GNU GPL v2.0 License */
(window.define==undefined?function(b,a){window.DumbQ=a($||jQuery)}:window.define)(["jquery"],function(b){if(!b){console.error("CreditPiggy: jQuery must available in order to use creditpiggy.js!");return null}var c=global.DumbQ={};var a=c.FrontEnd=function(){this.baseUrl=null;this.pollTimer=null;this.pollActive=false;this.disabled=false;this.online=false;this.seq_id=0;this.machine={};this.index={};this.instances=[]};a.prototype.__same=function(e,d){for(var f in e){if(e.hasOwnProperty(f)){if(d.hasOwnProperty(f)){if(typeof(e[f])!=typeof(d[f])){return false}if(typeof(e[f]=="object")){if(!this.__same(e[f],d[f])){return false}}if(e[f]!=d[f]){return false}}else{return false}}}for(var f in d){if(d.hasOwnProperty(f)&&!e.hasOwnProperty(f)){return false}}return true};a.prototype.__markOfflineInstance=function(d){if(d.offline){return}d.offline=true;b(this).triggerHandler("offline.instance",[d])};a.prototype.__updateInstance=function(d,e){if(d.offline){d.metrics=e;d.offline=false;b(this).triggerHandler("online.instance",[d]);b(this).triggerHandler("metrics.instance",[e,d]);return}if(!this.__same(d.metrics,e)){d.metrics=e;b(this).triggerHandler("metrics.instance",[e,d])}};a.prototype.__updateIndex=function(h){this.index=index;var l=index.instances||[];for(var f=0;f<l.length;f++){var g=l[f],k=false;for(var d=0;d<this.instances.length;d++){var e=this.instances[d];if(g.uuid==e.uuid){k=true;break}}if(!k){index.instances[f]["offline"]=true;index.instances[f]["metrics"]={};b(this).triggerHandler("created.instance",[g])}}for(var f=0;f<this.instances.length;f++){var g=this.instances[f],k=false;for(var d=0;d<l.length;d++){var e=l[d];if(g.uuid==e.uuid){k=true;break}}if(!k){b(this).triggerHandler("destroyed.instance",[g])}}this.instances=index.instances||[]};a.prototype.__updateMachine=function(d){this.machine=d;if(!this.offline){this.offline=false;b(this).triggerHandler("online",[this.machine])}};a.prototype.__markOffline=function(){if(this.offline){return}for(var d=0;d<this.instances.length;d++){this.__markOfflineInstance(this.instances[d])}this.instances=[];this.index={};this.machine={};this.offline=true;b(this).triggerHandler("offline")};a.prototype.__poll=function(){if(this.pollActive||this.disabled){return}var e=(function(){this.pollActive=false;this.pollTimer=setTimeout(this.__poll.bind(this),1000)}).bind(this);var g=(function(i,j){b.ajax({url:this.baseUrl+i.wwwroot+"/metrics.json",method:"GET",dataType:"json",data:{s:(this.seq_id++)}}).done((function(k){this.__updateInstance(i,k)}).bind(this)).fail((function(){this.__markOfflineInstance(i)}).bind(this)).always((function(){j()}).bind(this))}).bind(this);var f=(function(){var l=[e];for(var j=0;j<this.instances.length;j++){l.unshift((function(i){return function(m){g(i,m)}})(this.instances[j]))}var k=function(){if(l.length==1){var i=l.shift();i()}else{var i=l.shift();i(k)}};k()}).bind(this);var d=(function(){b.ajax({url:this.baseUrl+"/index.json",method:"GET",dataType:"json",data:{s:(this.seq_id++)}}).done((function(i){this.__updateIndex(i);f()}).bind(this)).fail((function(){this.__markOffline();e()}).bind(this))}).bind(this);var h=(function(){b.ajax({url:this.baseUrl+"/machine.json",method:"GET",dataType:"json",data:{s:(this.seq_id++)}}).done((function(i){this.__updateMachine(i);d()}).bind(this)).fail((function(){this.__markOffline();e()}).bind(this))}).bind(this);this.pollActive=null;if(this.offline){h()}else{d()}};a.prototype.enable=function(d){this.baseUrl=d;this.disabled=false;this.__poll()};a.prototype.disable=function(){if(this.disabled){return}this.disabled=true};return c});